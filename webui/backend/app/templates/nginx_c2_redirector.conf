server {
    listen 80;
    listen 443 ssl;

    server_name $vhost_base;

    # SSL certificate (stored in vhost config directory)
    ssl_certificate $cert_path;
    ssl_certificate_key $vh_key;

    # Logging
    access_log /var/log/nginx/$vhost_base-access.log;
    error_log /var/log/nginx/$vhost_base-error.log;

    # C2 Redirector Configuration
    # Proxy all requests to backend C2 server
    location / {
        # Backend C2 server (modify as needed)
        proxy_pass https://$$backend_c2_server;

        # Preserve original headers
        proxy_set_header Host $$host;
        proxy_set_header X-Real-IP $$remote_addr;
        proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $$scheme;

        # SSL verification (adjust based on backend)
        proxy_ssl_verify off;

        # Timeouts for C2 traffic
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # Hide redirector identity
        proxy_hide_header X-Powered-By;
        proxy_hide_header Server;
    }

    # Optional: Block known security scanner user agents
    if ($$http_user_agent ~* (nmap|masscan|nessus|nikto|sqlmap|burp|metasploit)) {
        return 403;
    }

    # Optional: Whitelist specific paths for C2 traffic
    # Uncomment and modify as needed
    # location ~ ^/(api|beacon|callback) {
    #     proxy_pass https://$$backend_c2_server;
    #     proxy_set_header Host $$host;
    #     proxy_set_header X-Real-IP $$remote_addr;
    # }

    # Optional: Serve legitimate-looking content on specific paths
    # location = / {
    #     root $html_dir;
    #     index index.html;
    # }
}
